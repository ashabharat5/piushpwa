<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="Hindi Panchang ‚Äî Dark Saffron Table" height="520">
    <Require feature="dynamic-height"/>
  </ModulePrefs>

  <Content type="html"><![CDATA[
<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hindi Panchang - Dark Saffron</title>

<style>
/* --- Customized Style Block --- */
:root {
  --color-dark-bg: #0d0c1d;     /* Very deep, almost black background */
  --color-card-bg: #1a203c;     /* Dark Indigo/Navy card */
  --color-detail-bg: #24294d;   /* Slightly lighter inner background */
  --color-saffron: #FF9933;     /* Saffron border/accent */
  --color-gold: #FFD700;        /* Gold highlight */
  --color-red: #ef4444;         /* Tailwind red-500 */
  --color-gray-text: #9ca3af;   /* Tailwind gray-400 */
  --color-white-text: #f7f7f7;
}

/* Fonts */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  font-family: 'Poppins', sans-serif;
  background-color: var(--color-dark-bg);
  color:var(--color-white-text);
  padding:12px;
  display:flex;
  justify-content:center;
  align-items:flex-start;
}

/* Card */
.card {
  width:100%;
  max-width:360px;
  background:var(--color-card-bg);
  border:3px solid var(--color-saffron);
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,0.6);
  padding:18px;
}

/* Title */
.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
  padding-bottom:8px;
  border-bottom: 2px dashed #333a60; /* Section separator */
}
.title {
  font-size:24px;
  font-weight:800;
  /* Applying a vibrant gradient effect */
  background:linear-gradient(90deg,var(--color-gold),var(--color-saffron));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.sub {
  font-size:12px;
  color:var(--color-gray-text);
}

/* Table styles */
#vvv { text-align:center; }
.panch-table {
  width:100%;
  border-collapse:collapse;
  margin:12px 0;
  background-color: var(--color-detail-bg); /* Use detail background for table */
  border-radius:8px;
  overflow:hidden;
  border:1px solid #333a60; /* Subtle border */
}
.panch-table tr + tr td { border-top:1px solid #333a60; }
.panch-table td {
  padding:10px 12px;
  font-size:14px;
}
.panch-table .label {
  color:var(--color-saffron);
  font-weight:700;
  width:40%;
  text-align:left;
}
.panch-table .value {
  text-align:right;
  color:var(--color-white-text);
  font-weight:600;
}

/* Special Rows */
.panch-table .sun-moon-header {
    background-color: #333a60; /* Darker bar */
    text-align:center; 
    padding:8px;
}
.panch-table .sun-moon-header span:first-child {
    color: var(--color-gold);
    font-weight:700;
    margin-right: 8px;
}


/* small muted line for sub info */
.muted {
  color:var(--color-gray-text);
  font-size:11px;
  margin-top:6px;
  font-weight: 400;
}

/* spinner fallback */
.spinner {
  display:block;
  margin:18px auto;
}

/* paste area fallback (hidden by default) */
#paste-wrap { margin-top:16px; display:none; gap:10px; flex-direction:column; background: #111529; padding: 12px; border-radius: 8px; border: 1px dashed #333a60;}
#xml-input { width:100%; min-height:120px; border-radius:8px; border:1px solid #333a60; background:#0e1224; color:var(--color-white-text); padding:10px; font-family:monospace; font-size:12px; resize:vertical; }
.btn { cursor:pointer; border-radius:8px; padding:10px 14px; border:none; font-weight:700; transition: background-color 0.2s;}
.btn-saff { background:var(--color-saffron); color:#111; }
.btn-saff:hover { background: #ffaa44; }
.btn-try { background:#475569; color:white; }
.btn-try:hover { background:#64748b; }

#error-msg { color:#fca5a5; font-size:13px; text-align:center; margin-top:8px; }
</style>

</head>
<body>
  <div class="card" role="application" aria-label="Hindi Panchang">
    <div class="header">
      <div>
        <div class="title">‡§¶‡•à‡§®‡§ø‡§ï ‡§™‡§û‡•ç‡§ö‡§æ‡§Ç‡§ó</div>
       
      </div>
      <div id="badge" class="sub">üïâÔ∏è</div>
    </div>

    <div id="vvv" align="center">
      <!-- initial spinner -->
      <img class="spinner" src="https://www.google.com/ig/images/spinner.gif" alt="loading">
    </div>



  </div>

<script>
/*
 * This script handles rendering the Panchang data based on a provided data object.
 * It includes functions for formatting astronomical values (degrees to DMS) and
 * logic for handling data from an external host, pasted XML, or a remote fetch.
 */

/* ---------- Helpers (formatting) ---------- */
function fix360(a){ a = Number(a); a = a % 360; if(a < 0) a += 360; return a; }

/** Converts longitude to Degrees/Minutes/Seconds with Zodiac Sign */
function lon2dmsz(lon){
  // input lon in degrees (0-360). returns "DD¬∞MM'SS\" Z"
  lon = Number(lon);
  lon = fix360(lon);
  const z = Math.floor(lon / 30) + 1; // zodiac sign 1..12
  const deg = Math.floor(lon % 30);
  const min = Math.floor((lon - Math.floor(lon)) * 60);
  const sec = Math.round(((lon - Math.floor(lon)) * 60 - min) * 60);
  return deg + "¬∞" + pad(min) + "'" + pad(sec) + "\"¬† (" + zodiacName(z) + ")";
}

/** Converts degrees to Degrees/Minutes/Seconds */
function lon2dms(lon){
  lon = Number(lon);
  lon = fix360(lon);
  const deg = Math.floor(lon);
  const min = Math.floor((lon - deg) * 60);
  const sec = Math.round(((lon - deg) * 60 - min) * 60);
  return deg + "¬∞" + pad(min) + "'" + pad(sec) + "\"";
}
function pad(n){ return (n<10? "0"+n: ""+n); }
function zodiacName(n){
  const names = ["‡§Æ‡•á‡§∑","‡§µ‡•É‡§∑‡§≠","‡§Æ‡§ø‡§•‡•Å‡§®","‡§ï‡§∞‡•ç‡§ï","‡§∏‡§ø‡§Ç‡§π","‡§ï‡§®‡•ç‡§Ø‡§æ","‡§§‡•Å‡§≤‡§æ","‡§µ‡•É‡§∂‡•ç‡§ö‡§ø‡§ï","‡§ß‡§®‡•Å","‡§Æ‡§ï‡§∞","‡§ï‡•Å‡§Æ‡•ç‡§≠","‡§Æ‡•Ä‡§®"];
  return names[(n-1)%12] || "";
}
function escapeHtml(s){
  if(s===null || s===undefined) return '';
  return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}

/* ---------- Default/Initial Data Structure ---------- */
const defaultData = {
  inpdate: (new Date()).toLocaleDateString('hi-IN', { dateStyle: 'full', timeStyle: 'short' }),
  Lmoon: 134.5,            // sample moon longitude degrees
  ayanamsa: 24.0,          // sample ayanamsa degrees
  s_wday: "‡§∂‡§®‡§ø‡§µ‡§æ‡§∞",
  n_tithi: 1,
  tith: ["‡§™‡•ç‡§∞‡§§‡§ø‡§™‡§¶‡§æ","‡§¶‡•ç‡§µ‡§ø‡§§‡•Ä‡§Ø‡§æ","‡§§‡•É‡§§‡•Ä‡§Ø‡§æ","‡§ö‡§§‡•Å‡§∞‡•ç‡§•‡•Ä","‡§™‡§Ç‡§ö‡§Æ‡•Ä","‡§∑‡§∑‡•ç‡§†‡•Ä","‡§∏‡§™‡•ç‡§§‡§Æ‡•Ä","‡§Ö‡§∑‡•ç‡§ü‡§Æ‡•Ä","‡§®‡§µ‡§Æ‡•Ä","‡§¶‡§∂‡§Æ‡•Ä","‡§è‡§ï‡§æ‡§¶‡§∂‡•Ä","‡§¶‡•ç‡§µ‡§æ‡§¶‡§∂‡•Ä","‡§§‡•ç‡§∞‡§Ø‡•ã‡§¶‡§∂‡•Ä","‡§ö‡§§‡•Å‡§∞‡•ç‡§¶‡§∂‡•Ä","‡§™‡•Ç‡§∞‡•ç‡§£‡§ø‡§Æ‡§æ/‡§Ö‡§Æ‡§æ‡§µ‡§∏‡•ç‡§Ø‡§æ"], 
  s_tithi: "15:30 ‡§§‡§ï (After 15:30: ‡§¶‡•ç‡§µ‡§ø‡§§‡•Ä‡§Ø‡§æ)",
  n_naksh: 2,
  naks: [{nname:"‡§Ö‡§∂‡•ç‡§µ‡§ø‡§®‡•Ä"},{nname:"‡§≠‡§∞‡§£‡•Ä"},{nname:"‡§ï‡•É‡§§‡•ç‡§§‡§ø‡§ï‡§æ"},{nname:"‡§∞‡•ã‡§π‡§ø‡§£‡•Ä"}],
  s_naksh: "09:45 ‡§§‡§ï",
  n_karana: 3,
  kar: ["‡§¨‡§µ","‡§¨‡§æ‡§≤‡§µ","‡§ï‡•å‡§≤‡§µ","‡§§‡•à‡§§‡§ø‡§≤","‡§ó‡§∞","‡§µ‡§£‡§ø‡§ú","‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø"],
  s_karana: "08:00 ‡§§‡§ï",
  n_yoga: 4,
  yog: ["‡§™‡•ç‡§∞‡•Ä‡§§‡§ø","‡§Ü‡§Ø‡•Å‡§∑‡•ç‡§Æ‡§æ‡§®","‡§∏‡•å‡§≠‡§æ‡§ó‡•ç‡§Ø","‡§∂‡•ã‡§≠‡§®","‡§Ö‡§§‡§ø‡§ó‡§£‡•ç‡§°"],
  s_yoga: "21:10 ‡§§‡§ï"
};

// make current values accessible from outside
window.__panchangData = Object.assign({}, defaultData);

/* ---------- UI Renderer (Generates HTML based on data) ---------- */
function results(){
  const D = window.__panchangData;
  const inpdate = D.inpdate || '';
  const Lmoon = Number(D.Lmoon || 0);
  const ayanamsa = Number(D.ayanamsa || 0);
  const s_wday = D.s_wday || '';
  const n_tithi = Number(D.n_tithi || 0);
  const tith = D.tith || [];
  const s_tithi = D.s_tithi || '';
  const n_naksh = Number(D.n_naksh || 0);
  const naks = D.naks || [];
  const s_naksh = D.s_naksh || '';
  const n_karana = Number(D.n_karana || 0);
  const kar = D.kar || [];
  const s_karana = D.s_karana || '';
  const n_yoga = Number(D.n_yoga || 0);
  const yog = D.yog || [];
  const s_yoga = D.s_yoga || '';

  let panch = '<div align="center"><span style="font-family:Courier New, Mangal, mono; font-size:12px; color: var(--color-gray-text);">‡§∏‡§Æ‡§Ø:&nbsp;'+ escapeHtml(inpdate) + '</span></div>';

  // Sun/Moon position (using Lmoon + ayanamsa as in your code)
  panch += '<table class="panch-table">';
  panch += '<tr><td colspan="2" class="sun-moon-header"><span>‡§∏‡•Ç‡§∞‡•ç‡§Ø / ‡§ö‡§Ç‡§¶‡•ç‡§∞‡§Æ‡§æ:</span> <span style="font-weight:600; color: var(--color-white-text);">' + escapeHtml(lon2dmsz(fix360(Lmoon + ayanamsa))) + '</span></td></tr></table>';

  panch += '<table class="panch-table">';
  panch += '<tr><td class="label">‡§µ‡§æ‡§∞:</td><td class="value">' + escapeHtml(s_wday) + '</td></tr>';

  // Tithi
  const tithiText = (tith[n_tithi] ? ( tith[n_tithi] ) : '‚Äî');
  panch += '<tr><td class="label">‡§§‡§ø‡§•‡§ø (Lunar Day):</td><td class="value">' + escapeHtml(tithiText) + '<div class="muted">' + escapeHtml(s_tithi) + '</div></td></tr>';

  // Nakshatra
  const nakText = (naks[n_naksh] && naks[n_naksh].nname) ? (naks[n_naksh].nname) : '‚Äî';
  panch += '<tr><td class="label">‡§®‡§ï‡•ç‡§∑‡§§‡•ç‡§∞ (Star):</td><td class="value">' + escapeHtml(nakText) + '<div class="muted">' + escapeHtml(s_naksh) + '</div></td></tr>';

  // Karana
  const karText = kar[n_karana] ? (kar[n_karana]) : '‚Äî';
  panch += '<tr><td class="label">‡§ï‡§∞‡§£ (Half-Tithi):</td><td class="value">' + escapeHtml(karText) + '<div class="muted">' + escapeHtml(s_karana) + '</div></td></tr>';

  // Yoga
  const yogText = yog[n_yoga] ? (yog[n_yoga]) : '‚Äî';
  panch += '<tr><td class="label">‡§Ø‡•ã‡§ó (Conjunction):</td><td class="value">' + escapeHtml(yogText) + '<div class="muted">' + escapeHtml(s_yoga) + '</div></td></tr>';

  panch += '</table>';

  // Ayanamsa small row
  panch += '<table class="panch-table"><tr><td class="sun-moon-header" style="background-color: var(--color-card-bg); border-top: 1px solid #333a60;"><span style="color:var(--color-saffron); margin-right: 8px;">Ayanamsa:</span> <span style="font-weight:600; color: var(--color-white-text); font-size: 14px;">' + escapeHtml(lon2dms(ayanamsa)) + '</span></td></tr></table>';

  document.getElementById("vvv").innerHTML = panch;
}

/* ---------- External API: host can call this to fill real data ---------- */
window.fillPanchangFromHost = function(data){
  try {
    window.__panchangData = Object.assign({}, window.__panchangData, data || {});
    document.getElementById('inpdate_display').textContent = window.__panchangData.inpdate || '';
    results();
    // Hide the paste area on successful data fill
    document.getElementById('paste-wrap').style.display = 'none';
    document.getElementById('error-msg').textContent = "";
  } catch(e){
    console.error('fillPanchangFromHost error', e);
    document.getElementById('error-msg').textContent = "Apply failed: " + e.message;
    document.getElementById('paste-wrap').style.display = 'flex';
  }
};

/* ---------- XML paste parser (fallback) ---------- */
function parseXmlTextToData(txt){
  try {
    const parser = new DOMParser();
    const xmldoc = parser.parseFromString(txt, "application/xml");
    if(xmldoc.getElementsByTagName('parsererror').length) throw new Error('XML parse error');
    const g = tag => {
      const el = xmldoc.getElementsByTagName(tag)[0];
      if(el && el.textContent) return el.textContent.trim();
      return null;
    };
    
    const data = {};
    data.inpdate = g('date') || g('full_date') || data.inpdate;
    data.Lmoon = Number(g('Lmoon') || g('moonLong') || g('moon_lon') || data.Lmoon || 0);
    data.ayanamsa = Number(g('ayanamsa') || g('ayan') || data.ayanamsa || 0);
    data.s_wday = g('weekday') || g('day') || data.s_wday;
    // Note: Since we don't know the full array for tith, naks, kar, yog, we rely on the index and the s_ description.
    data.n_tithi = Number(g('n_tithi') || g('tithi_index') || data.n_tithi || 0);
    data.s_tithi = g('s_tithi') || g('tithi_text') || g('tithi') || defaultData.s_tithi;
    data.n_naksh = Number(g('n_naksh') || g('nak_index') || data.n_naksh || 0);
    data.s_naksh = g('s_naksh') || g('nakshatra_text') || g('nakshatra') || defaultData.s_naksh;
    data.n_karana = Number(g('n_karana') || 0);
    data.s_karana = g('s_karana') || defaultData.s_karana;
    data.n_yoga = Number(g('n_yoga') || 0);
    data.s_yoga = g('s_yoga') || defaultData.s_yoga;

    return data;
  } catch(e){
    return null;
  }
}

document.getElementById('apply-xml').addEventListener('click', function(){
  const txt = document.getElementById('xml-input').value.trim();
  if(!txt){
    document.getElementById('error-msg').textContent = "‡§™‡•ç‡§≤‡•Ä‡§ú‡§º XML ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§ (Please paste XML.)";
    return;
  }
  const mapped = parseXmlTextToData(txt);
  if(mapped){
    window.fillPanchangFromHost(mapped);
    document.getElementById('error-msg').textContent = "XML ‡§≤‡§æ‡§ó‡•Ç ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§ (XML applied successfully.)";
  } else {
    document.getElementById('error-msg').textContent = "XML ‡§™‡§æ‡§∞‡•ç‡§∏‡§ø‡§Ç‡§ó ‡§µ‡§ø‡§´‡§≤‡•§ (XML parsing failed.)";
    document.getElementById('paste-wrap').style.display = 'flex';
  }
});

/* ---------- Try remote fetch (best-effort) ---------- */
const REMOTE = "http://hosting.gmodules.com/ig/gadgets/file/109787730588197067267/hindi_panchang.xml";
async function tryFetchRemote(){
  document.getElementById('error-msg').textContent = "Fetching remote XML ...";
  try {
    // Note: Fetching cross-origin may fail depending on the execution environment.
    const r = await fetch(REMOTE, {mode:'cors', cache:'no-store'});
    if(!r.ok) throw new Error('HTTP ' + r.status);
    const txt = await r.text();
    
    const mapped = parseXmlTextToData(txt);
    if(mapped){
      window.fillPanchangFromHost(mapped);
      document.getElementById('paste-wrap').style.display = 'none';
      document.getElementById('error-msg').textContent = "";
      return;
    } else {
      document.getElementById('xml-input').value = txt;
      document.getElementById('paste-wrap').style.display = 'flex';
      document.getElementById('error-msg').textContent = "Remote fetched but custom tags not recognized ‚Äî pasted content in box for manual Apply.";
    }
  } catch(e){
    document.getElementById('paste-wrap').style.display = 'flex';
    document.getElementById('error-msg').textContent = "Remote fetch failed: " + e.message + ". Please paste XML manually.";
  }
}
document.getElementById('try-fetch').addEventListener('click', tryFetchRemote);

/* ---------- Init gadget (auto-fill default sample and run) ---------- */
function initgadget(){
  // set header date
  document.getElementById('inpdate_display').textContent = window.__panchangData.inpdate;
  results();
  
  // Try remote fetch (best-effort) but do not block
  tryFetchRemote();
  
  // Adjust iframe height if host provides (for gadgets platform)
  try { if(typeof _IG_AdjustIFrameHeight === 'function') _IG_AdjustIFrameHeight(); } catch(e){}
}

// expose init so gadget host can call if needed
window.initgadget = initgadget;

// Auto init after small delay
setTimeout(initgadget, 400);

</script>
</body>
</html>
  ]]></Content>
</Module>
