<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="Hindi Panchang ‚Äî Dark Saffron Table" height="520">
    <Require feature="dynamic-height"/>
  </ModulePrefs>

  <Content type="html"><![CDATA[
<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hindi Panchang - Dark Saffron</title>

<style>
:root {
    --color-dark-bg: #0d0c1d;
    --color-card-bg: #1a203c;
    --color-detail-bg: #24294d;
    --color-saffron: #FF9933;
    --color-gold: #FFD700;
    --color-red: #ef4444;
    --color-gray-text: #9ca3af;
    --color-white-text: #f7f7f7;
}

/* Fonts */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  font-family: 'Poppins', sans-serif;
  background-color: var(--color-dark-bg);
  color:var(--color-white-text);
  padding:12px;
  display:flex;
  justify-content:center;
  align-items:flex-start;
}

/* Card */
.card {
  width:100%;
  max-width:360px;
  background:var(--color-card-bg);
  border:3px solid var(--color-saffron);
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,0.6);
  padding:18px;
}

/* Title */
.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.title {
  font-size:20px;
  font-weight:800;
  background:linear-gradient(90deg,var(--color-gold),var(--color-saffron));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.sub {
  font-size:12px;
  color:var(--color-gray-text);
}

/* Table styles (converted from your original) */
#vvv { text-align:center; }
.panch-table {
  width:100%;
  border-collapse:collapse;
  margin:8px 0;
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
  border-radius:8px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,0.03);
}
.panch-table tr + tr td { border-top:1px solid rgba(255,255,255,0.03); }
.panch-table td {
  padding:8px 10px;
  font-size:13px;
}
.panch-table .label {
  color:var(--color-saffron);
  font-weight:700;
  width:40%;
  text-align:left;
}
.panch-table .value {
  text-align:right;
  color:var(--color-white-text);
  font-weight:600;
}

/* small muted line for sub info */
.muted {
  color:var(--color-gray-text);
  font-size:11px;
  margin-top:6px;
}

/* spinner fallback */
.spinner {
  display:block;
  margin:18px auto;
}

/* paste area fallback (hidden by default) */
#paste-wrap { margin-top:12px; display:none; gap:6px; flex-direction:column; }
#xml-input { width:100%; min-height:120px; border-radius:8px; border:1px solid #333a60; background:#0e1224; color:var(--color-white-text); padding:10px; font-family:monospace; font-size:12px; resize:vertical; }
.btn { cursor:pointer; border-radius:8px; padding:8px 12px; border:none; font-weight:700; }
.btn-saff { background:var(--color-saffron); color:#111; }
.btn-try { background:#334155; color:white; }

#error-msg { color:#ffb4b4; font-size:13px; text-align:center; margin-top:8px; }
</style>

</head>
<body>
  <div class="card" role="application" aria-label="Hindi Panchang">
    <div class="header">
      <div>
        <div class="title">‡§¶‡•à‡§®‡§ø‡§ï ‡§™‡§û‡•ç‡§ö‡§æ‡§Ç‡§ó</div>
        <div class="sub" id="inpdate_display">Loading...</div>
      </div>
      <div id="badge" class="sub">üïâÔ∏è</div>
    </div>

    <div id="vvv" align="center">
      <!-- initial spinner -->
      <img class="spinner" src="https://www.google.com/ig/images/spinner.gif" alt="loading">
      <br><br>
    </div>

    <div id="paste-wrap">
      <div class="sub">‡§Ø‡§¶‡§ø remote fetch ‡§ï‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à ‚Äî ‡§Ö‡§™‡§®‡§æ ‡§™‡•Å‡§∞‡§æ‡§®‡§æ XML ‡§Ø‡§π‡§æ‡§Å ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç:</div>
      <textarea id="xml-input" placeholder="Paste your hindi_panchang.xml here..."></textarea>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:6px">
        <button id="apply-xml" class="btn btn-saff">Apply XML</button>
        <button id="try-fetch" class="btn btn-try">Try remote fetch</button>
      </div>
      <div id="error-msg" role="status" aria-live="polite"></div>
    </div>

  </div>

<script>
/*
  Adapted results() + helper functions.
  This widget will:
  - try remote fetch (best-effort)
  - allow host page to call window.fillPanchangFromHost(data) with real values
  - allow manual paste (Apply XML) to populate values
*/

/* ---------- Helpers (formatting) ---------- */
function fix360(a){ a = Number(a); a = a % 360; if(a < 0) a += 360; return a; }

function lon2dmsz(lon){
  // input lon in degrees (0-360). returns "DD¬∞MM'SS\" Z"
  lon = Number(lon);
  lon = fix360(lon);
  const z = Math.floor(lon / 30) + 1; // zodiac sign 1..12
  const deg = Math.floor(lon % 30);
  const min = Math.floor((lon - Math.floor(lon)) * 60);
  const sec = Math.round(((lon - Math.floor(lon)) * 60 - min) * 60);
  return deg + "¬∞" + pad(min) + "'" + pad(sec) + "\"  (" + zodiacName(z) + ")";
}
function lon2dms(lon){
  lon = Number(lon);
  lon = fix360(lon);
  const deg = Math.floor(lon);
  const min = Math.floor((lon - deg) * 60);
  const sec = Math.round(((lon - deg) * 60 - min) * 60);
  return deg + "¬∞" + pad(min) + "'" + pad(sec) + "\"";
}
function pad(n){ return (n<10? "0"+n: ""+n); }
function zodiacName(n){
  const names = ["‡§Æ‡•á‡§∑","‡§µ‡•É‡§∑‡§≠","‡§Æ‡§ø‡§•‡•Å‡§®","‡§ï‡§∞‡•ç‡§ï","‡§∏‡§ø‡§Ç‡§π","‡§ï‡§®‡•ç‡§Ø‡§æ","‡§§‡•Å‡§≤‡§æ","‡§µ‡•É‡§∂‡•ç‡§ö‡§ø‡§ï","‡§ß‡§®‡•Å","‡§Æ‡§ï‡§∞","‡§ï‡•Å‡§Æ‡•ç‡§≠","‡§Æ‡•Ä‡§®"];
  return names[(n-1)%12] || "";
}

/* ---------- UI fill using a data object ---------- */
const defaultData = {
  inpdate: (new Date()).toLocaleString('hi-IN', { dateStyle: 'full', timeStyle: 'short' }),
  Lmoon: 134.5,           // sample moon longitude degrees
  ayanamsa: 24.0,         // sample ayanamsa degrees
  s_wday: "‡§∂‡§®‡§ø‡§µ‡§æ‡§∞",
  n_tithi: 1,
  tith: ["‡§™‡•ç‡§∞‡§•‡§Æ","‡§¶‡•ç‡§µ‡§ø‡§§‡•Ä‡§Ø‡§æ","‡§§‡•É‡§§‡•Ä‡§Ø‡§æ","‡§ö‡§§‡•Å‡§∞‡•ç‡§•‡•Ä","‡§™‡§Ç‡§ö‡§Æ‡•Ä","‡§∑‡§∑‡•ç‡§†‡•Ä","‡§∏‡§™‡•ç‡§§‡§Æ‡•Ä","‡§Ö‡§∑‡•ç‡§ü‡§Æ‡•Ä","‡§®‡§µ‡§Æ‡•Ä","‡§¶‡§∂‡§Æ‡•Ä","‡§è‡§ï‡§æ‡§¶‡§∂‡•Ä","‡§¶‡•ç‡§µ‡¶æ‡¶¶‡§∂‡•Ä","‡§§‡•ç‡§∞‡§Ø‡•ã‡§¶‡§∂‡•Ä","‡§ö‡§§‡•Å‡§∞‡•ç‡§¶‡§∂‡•Ä","‡§™‡•Ç‡§∞‡•ç‡§£/‡§Ö‡§Æ‡§æ‡§µ‡§∏‡•ç‡§Ø‡§æ"], // sample
  s_tithi: "‡§§‡§ø‡§•‡§ø ‡§µ‡§ø‡§µ‡§∞‡§£",
  n_naksh: 2,
  naks: [{nname:"‡§Ö‡§∂‡•ç‡§µ‡§ø‡§®‡•Ä"},{nname:"‡§≠‡§∞‡§£‡•Ä"},{nname:"‡§ï‡•É‡§§‡•ç‡§§‡§ø‡§ï‡§æ"},{nname:"‡§∞‡•ã‡§π‡§ø‡§£‡•Ä"}],
  s_naksh: "‡§®‡§ï‡•ç‡§∑‡§§‡•ç‡§∞ ‡§µ‡§ø‡§µ‡§∞‡§£",
  n_karana: 3,
  kar: ["‡§ï‡§ü‡•ç‡§ü‡§∞","‡§ó‡§∞","‡§µ‡§£‡§ø‡§ú","‡§µ‡§£‡§ø‡§ú2","‡§ï‡§ü‡•ç‡§ü‡§∞2","‡§ó‡§∞2"],
  s_karana: "‡§ï‡§∞‡§£ ‡§µ‡§ø‡§µ‡§∞‡§£",
  n_yoga: 4,
  yog: ["‡§µ‡§ø‡§ï‡§∞‡•ç‡§£","‡§∂‡•Ç‡§≤","‡§ó‡§£‡•ç‡§°","‡§µ‡§ø‡§ï‡§∞‡•ç‡§£2","‡§∂‡•Ç‡§≤2"],
  s_yoga: "‡§Ø‡•ã‡§ó ‡§µ‡§ø‡§µ‡§∞‡§£"
};

// make current values accessible from outside
window.__panchangData = Object.assign({}, defaultData);

/* results() converted to use data */
function results(){
  const D = window.__panchangData;
  const inpdate = D.inpdate || '';
  const Lmoon = Number(D.Lmoon || 0);
  const ayanamsa = Number(D.ayanamsa || 0);
  const s_wday = D.s_wday || '';
  const n_tithi = Number(D.n_tithi || 0);
  const tith = D.tith || [];
  const s_tithi = D.s_tithi || '';
  const n_naksh = Number(D.n_naksh || 0);
  const naks = D.naks || [];
  const s_naksh = D.s_naksh || '';
  const n_karana = Number(D.n_karana || 0);
  const kar = D.kar || [];
  const s_karana = D.s_karana || '';
  const n_yoga = Number(D.n_yoga || 0);
  const yog = D.yog || [];
  const s_yoga = D.s_yoga || '';

  let panch = '<div align="center"><span style="font-family:Courier New, Mangal, mono; font-size:13px">‡§∏‡§Æ‡§Ø:&nbsp;'+ escapeHtml(inpdate) + '</span></div><br>';

  // Sun/Moon position (using Lmoon + ayanamsa as in your code)
  panch += '<table class="panch-table" style="background:#fffff0"><tr><td colspan="2" style="background:#999999;height:4px"></td></tr>';
  panch += '<tr><td class="label" colspan="2" style="text-align:center; padding:8px;"><span style="color:#3DB679;font-weight:700">‡§∏‡•Ç‡§∞‡•ç‡§Ø:</span> <span style="font-weight:600;">' + escapeHtml(lon2dmsz(fix360(Lmoon + ayanamsa))) + '</span></td></tr></table>';

  panch += '<table class="panch-table">';
  panch += '<tr><td class="label">‡§µ‡§æ‡§∞:</td><td class="value">' + escapeHtml(s_wday) + '</td></tr>';

  // Tithi
  const tithiText = (tith[n_tithi] ? ( (n_tithi+1)+'. '+ tith[n_tithi] ) : '‚Äî');
  panch += '<tr><td class="label">‡§§‡§ø‡§•‡§ø:</td><td class="value">' + escapeHtml(tithiText) + '<div class="muted">' + escapeHtml(s_tithi) + '</div></td></tr>';

  // Nakshatra
  const nakText = (naks[n_naksh] && naks[n_naksh].nname) ? ((n_naksh+1)+'. ' + naks[n_naksh].nname) : '‚Äî';
  panch += '<tr><td class="label">‡§®‡§ï‡•ç‡§∑‡§§‡•ç‡§∞:</td><td class="value">' + escapeHtml(nakText) + '<div class="muted">' + escapeHtml(s_naksh) + '</div></td></tr>';

  // Karana
  const karText = kar[n_karana] ? ((n_karana+1)+'. ' + kar[n_karana]) : '‚Äî';
  panch += '<tr><td class="label">‡§ï‡§∞‡§£:</td><td class="value">' + escapeHtml(karText) + '<div class="muted">' + escapeHtml(s_karana) + '</div></td></tr>';

  // Yoga
  const yogText = yog[n_yoga] ? ((n_yoga+1)+'. ' + yog[n_yoga]) : '‚Äî';
  panch += '<tr><td class="label">‡§Ø‡•ã‡§ó:</td><td class="value">' + escapeHtml(yogText) + '<div class="muted">' + escapeHtml(s_yoga) + '</div></td></tr>';

  panch += '</table>';

  // Ayanamsa small row
  panch += '<table class="panch-table"><tr><td style="text-align:center;padding:8px"><span style="color:#3DB679;font-weight:700">Ayanamsa:</span> <span>' + escapeHtml(lon2dms(ayanamsa)) + '</span></td></tr></table>';

  document.getElementById("vvv").innerHTML = panch;
}

/* ---------- Quick format helpers (already defined above) ---------- */
// escapeHTML
function escapeHtml(s){
  if(s===null || s===undefined) return '';
  return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}

/* ---------- External API: host can call this to fill real data ---------- */
/*
 Expected data format (example):
 window.fillPanchangFromHost({
   inpdate: "‡§∂‡§®‡§ø‡§µ‡§æ‡§∞, 15 ‡§®‡§µ‡§Æ‡•ç‡§¨‡§∞ 2025",
   Lmoon: 134.5,
   ayanamsa: 24.0,
   s_wday: "‡§∂‡§®‡§ø‡§µ‡§æ‡§∞",
   n_tithi: 1,
   tith: ["‡§™‡•ç‡§∞‡§•‡§Æ","‡§¶‡•ç‡§µ‡§ø‡§§‡•Ä‡§Ø‡§æ",...],
   s_tithi: "‡§§‡§ø‡§•‡§ø ‡§µ‡§ø‡§µ‡§∞‡§£",
   n_naksh: 2,
   naks: [{nname:"‡§∞‡§µ‡§ø‡§≠"},...],
   s_naksh: "...",
   n_karana: 3, kar: [...], s_karana: "...",
   n_yoga: 4, yog: [...], s_yoga: "..."
 });
*/
window.fillPanchangFromHost = function(data){
  try {
    window.__panchangData = Object.assign({}, window.__panchangData, data || {});
    // update small header date display
    document.getElementById('inpdate_display').textContent = window.__panchangData.inpdate || '';
    results();
  } catch(e){
    console.error('fillPanchangFromHost error', e);
    document.getElementById('error-msg').textContent = "Apply failed: " + e.message;
  }
};

/* ---------- XML paste parser (fallback) ---------- */
function parseXmlTextToData(txt){
  try {
    const parser = new DOMParser();
    const xmldoc = parser.parseFromString(txt, "application/xml");
    if(xmldoc.getElementsByTagName('parsererror').length) throw new Error('XML parse error');
    const g = tag => {
      const el = xmldoc.getElementsByTagName(tag)[0];
      if(el && el.textContent) return el.textContent.trim();
      return null;
    };
    // Map likely tags (best-effort)
    const data = {};
    data.inpdate = g('date') || g('full_date') || data.inpdate;
    data.Lmoon = Number(g('Lmoon') || g('moonLong') || g('moon_lon') || data.Lmoon || 0);
    data.ayanamsa = Number(g('ayanamsa') || g('ayan') || data.ayanamsa || 0);
    data.s_wday = g('weekday') || g('day') || data.s_wday;
    data.n_tithi = Number(g('n_tithi') || g('tithi_index') || data.n_tithi || 0);
    data.tith = []; // leave unknown
    // try tithi text
    data.s_tithi = g('s_tithi') || g('tithi_text') || g('tithi');
    data.n_naksh = Number(g('n_naksh') || g('nak_index') || data.n_naksh || 0);
    data.s_naksh = g('s_naksh') || g('nakshatra') || '';
    data.n_karana = Number(g('n_karana') || 0);
    data.s_karana = g('s_karana') || '';
    data.n_yoga = Number(g('n_yoga') || 0);
    data.s_yoga = g('s_yoga') || '';

    return data;
  } catch(e){
    console.error('parseXmlTextToData', e);
    return null;
  }
}

document.getElementById('apply-xml').addEventListener('click', function(){
  const txt = document.getElementById('xml-input').value.trim();
  if(!txt){
    document.getElementById('error-msg').textContent = "‡§™‡•ç‡§≤‡•Ä‡§ú‡§º XML ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§";
    return;
  }
  const mapped = parseXmlTextToData(txt);
  if(mapped){
    window.fillPanchangFromHost(mapped);
    document.getElementById('error-msg').textContent = "XML ‡§≤‡§æ‡§ó‡•Ç ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§";
  } else {
    document.getElementById('error-msg').textContent = "XML ‡§™‡§æ‡§∞‡•ç‡§∏‡§ø‡§Ç‡§ó ‡§µ‡§ø‡§´‡§≤‡•§";
  }
});

/* ---------- Try remote fetch (best-effort) ---------- */
const REMOTE = "http://hosting.gmodules.com/ig/gadgets/file/109787730588197067267/hindi_panchang.xml";
async function tryFetchRemote(){
  document.getElementById('error-msg').textContent = "Fetching remote XML ...";
  try {
    const r = await fetch(REMOTE, {mode:'cors', cache:'no-store'});
    if(!r.ok) throw new Error('HTTP ' + r.status);
    const txt = await r.text();
    // Try parse and fill via mapping
    const mapped = parseXmlTextToData(txt);
    if(mapped){
      window.fillPanchangFromHost(mapped);
      document.getElementById('paste-wrap').style.display = 'none';
      document.getElementById('error-msg').textContent = "";
      return;
    } else {
      // maybe remote contains <Module> wrapper ‚Äî try to extract inner content tags
      document.getElementById('xml-input').value = txt;
      document.getElementById('paste-wrap').style.display = 'flex';
      document.getElementById('error-msg').textContent = "Remote fetched but custom tags not recognized ‚Äî pasted content in box for manual Apply.";
    }
  } catch(e){
    document.getElementById('paste-wrap').style.display = 'flex';
    document.getElementById('error-msg').textContent = "Remote fetch failed: " + e.message;
  }
}
document.getElementById('try-fetch').addEventListener('click', tryFetchRemote);

/* ---------- Init gadget (auto-fill default sample and run) ---------- */
function initgadget(){
  // set header date
  document.getElementById('inpdate_display').textContent = window.__panchangData.inpdate;
  results();
  // try fetch remote (best-effort) but do not block
  tryFetchRemote();
  // adjust iframe height if host provides (for gadgets platform)
  try { if(typeof _IG_AdjustIFrameHeight === 'function') _IG_AdjustIFrameHeight(); } catch(e){}
}

// expose init so gadget host can call if needed
window.initgadget = initgadget;

// auto init after small delay
setTimeout(initgadget, 400);

</script>
</body>
</html>
  ]]></Content>
</Module>
